const nbRows = 32;
const nbCols = 32;
const nbPhases = 8;

const malware = new Malware("#overlay", {
  nbRows,
  nbCols,
  nbPhases,
  onEnd: () => {
    const endAnimationContainer = document.querySelector(".malwareEnd");
    const malwareEndVideoElement = document.querySelector(".malwareEnd-video");
    const filledArray = document.querySelectorAll(".filled");
    filledArray.forEach((filled) => {
      filled.style.backgroundColor = "#000000da";
    });
    
    endAnimationContainer.classList.add("malwareEnd-active");
    socket.emit("disableMalware", "20000");

    fetch("http://localhost:3005/api/clip")
    .then(response => {
      if (response.ok) {
        // Parsez la réponse JSON
        return response.json();
      }
      // Si la réponse n'est pas OK, lancez une erreur
      throw new Error('Problème de récuperation du clip');
    })
    .then(data => {
      const iframe = document.createElement("iframe")
      iframe.src = `${data.embed}&parent=localhost&autoplay=true&width=640&height=360`
      iframe.width = "640"
      iframe.height = "360"
      malwareEndVideoElement.appendChild(iframe)
      setTimeout(() => {
        // Remove the end animation
        iframe.remove()
        endAnimationContainer.classList.remove("malwareEnd-active");
        // Reset malware
        const divEnd = document.createElement("div");
        divEnd.className = "malwareEnd";
        divEnd.innerHTML = endAnimationContainer.innerHTML;
        malware.reset(); // l'overlay est vidé de tout, même les composants d'animation !!
  
        document.querySelector("#overlay").prepend(divEnd); // rebuild... he he he
      }, Number(Math.floor(data.duration * 1000)));
    })
    .catch(error => {
      // Gérez les erreurs de réseau ou les erreurs liées à l'API ici
      console.error('Erreur lors de la récupération des données:', error);
    })

  },
});

const handleFillCell = (count) => {
  console.log("malware client");
  for (let i = 0; i < count; i++) {
    malware.fillCell();
  }
};

malware.init();

socket.on("Malware", handleFillCell);
